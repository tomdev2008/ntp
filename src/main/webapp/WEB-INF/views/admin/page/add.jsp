<%@page pageEncoding="UTF-8"%><%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%><%@ taglib prefix="j" uri="/WEB-INF/tld/formtag.tld"%><j:set name="ctx" value="${pageContext.request.contextPath}" /><!DOCTYPE html><html lang="zh_CN"><head><%-- <link href="${ctx}/resources/css/global.css" rel="stylesheet" type="text/css"><link href="${ctx}/resources/css/template_detail.css" rel="stylesheet" type="text/css"> --%><link rel="stylesheet" type="text/css" href="${ctx}/resources/css/jquery.autocomplete.css"><link rel="stylesheet" type="text/css" href="${ctx}/resources/kindeditor/themes/default/default.css" /></head><body>    <div class="page-header">    			<a href="${ctx}/admin/page/list?ptype=${ptype}" class="backParent">                <span id="back">返回列表</span>               </a>                <h4>添加设置</h4>                <div class="btn-group">                    <button class="btn btn-large btn-primary" type="button" onclick="saveMater();">保存</button>               </div>    </div>	<div class="page-body editingBody">	 				<form class="form-horizontal" method="post" id="inputForm"			action="${ctx}/admin/page/savePageConfig" name="form">			<input type="hidden" name="ptype" id="ptype" value="${ptype}" />			<section id="set-exam" class="section">				<c:if test="${ptype eq '02' }">				   <div class="section">					<label for="SchoolCover">学校封面</label> 					<input id="SchoolCover" name="SchoolCover" class="input-block-level" type="hidden"/>					<!--图片剪切-->					<div class="cutimg-box no" style="display: none;">						<iframe id="iframeimg" width="100%" height="500" id="win"							name="win" frameborder="0" scrolling="no" src=""></iframe>					</div>					<!--图片预览-->					<div class="courseCover">						<img id="imgshow" name="imgshow" style="width: 300px; height: 200px;" src="${ctx}/resources/images/hoverfold-01.jpg"alt="" />					</div>				</div>				</c:if> 				<div class="control-group">					<label class="control-label"> 					<c:if test="${ptype eq '01' }">老师:</c:if> 					<c:if test="${ptype eq '02' }">学校:</c:if>					</label>					<div class="controls controls-txt">						<c:if test="${ptype eq '01' }">							<input type="text" name="teacher" id="teacher" class="input-block-level valid"								required width="180px">						</c:if>						<c:if test="${ptype eq '02' }">							<input type="text" name="school" id="school" class="span6"								required width="180px">						</c:if>						<input type="hidden" name="fdElementName" id="fdElementName">						<input type="hidden" name="fdElementId" id="fdElementId">					</div>				</div>				<div class="control-group">					<label class="control-label">内容:</label>					<div class="controls">						<textarea rows="2" name="fdContent" id="fdContent"							class="input-block-level valid" required maxlength=30></textarea>					</div>				</div>			</section>			<c:if test="${ptype eq '02' }">				<div class="section mt20">						<label>上传图片（支持JPG\JPEG、PNG、BMP格式的图片，建议小于2M）</label>						<div class="control-upload">                         <span class="progress"> <div class="bar" style="width:0;"></div> </span>					     <span class="txt"><span class="pct">0%</span>，剩余时间：<span class="countdown">00:00:00</span></span>						     <button id="upPagePic" class="btn btn-primary btn-large" type="button" >上传</button>							<input type="hidden"  name="attIdID" id="attIdID">					</div>					</div>			</c:if>			<button class="btn btn-block btn-submit btn-inverse" type="submit">保存</button>		</form>	</div>	<script type="text/javascript" src="${ctx}/resources/js/jquery.validate.min.js"></script><script type="text/javascript" src="${ctx}/resources/js/messages_zh.js"></script><script type="text/javascript" src="${ctx}/resources/uploadify/jquery.uploadify.js?id=1211"></script><script type="text/javascript" src="${ctx}/resources/js/jquery.autocomplete.pack.js"></script><script type="text/javascript" src="${ctx}/resources/js/jquery.jalert.js" type="text/javascript"></script><script type="text/javascript" src="${ctx}/resources/js/jquery.placeholder.1.3.min.js"></script><script type="text/javascript"> 	jQuery(document).ready(function() { 		 $("#inputForm").validate({             submitHandler: function(form){            	 //必填验证结束后 验证用户的信息         		  if($("#fdElementId").val()==""){        			if($("#ptype").val()=="01"){        				$("#teacher").after("<label id='errorinfo' class='error'>请从下拉菜单中选择该信息</label>");        				return false;        			}else{        				$("#school").after("<label id='errorinfo' class='error'>请从下拉菜单中选择该信息</label>");        				return false;        			}        		}         		//如果已经添加过的 则不能再添加(此处不进行删除后再次添加原因在于前台的顺序控制)        		flag=true;        		$.ajax({url: "${ctx}/ajax/page/checkUnique",        				async:false,        				data:{        					ptype:$("#ptype").val(),        					fdElementId:$("#fdElementId").val(),        					fdname:$("#fdElementName").val()        					},        				dataType:'json',        				success: function(result){        					if(result.match){//当前输入信息和id信息是否匹配()        						if($("#ptype").val()=="01"){//老师        							if(!result.ispermit){//是否已添加过该信息        								$("#teacher").after("<label  id='errorinfo' class='error'>当前人员已添加过</label>");        								flag=false;        							}        						}else{//学校        							if(!result.ispermit){        								$("#school").after("<label id='errorinfo'  class='error'>当前机构已添加过</label>");        								flag=false;        							}        						}        					}else{//不匹配则说明不是从下拉框中选择        						if($("#ptype").val()=="01"){        							$("#teacher").after("<label  id='errorinfo' class='error'>请从下拉菜单中选择</label>");        							flag=false;        						}else{        							$("#school").after("<label id='errorinfo' class='error'>请从下拉菜单中选择</label>");        							flag=false;        						}        					}        				}         		});        		if(flag){        			form.submit();        		}             } 		 })			}); 	$(function() {		$("#rightCont .bder2").remove();		//加普通人员信息		if ($("#teacher")[0]) {			$("#teacher").autocomplete(					"${ctx}/ajax/user/findByName",					{						matchContains : true,						max : 100,						width : 669,						dataType : 'json',						// 加入对返回的json对象进行解析的函数，函数返回一个数组						parse : function(data) {							var rows = [];							for ( var i = 0; i < data.length; i++) {								rows[rows.length] = {									data : data[i],									value : data[i].name,									result : data[i].name								// 显示在输入文本框里的内容 ,								};							}							return rows;						},						formatItem : function(item) {							var photo;							if (item.imgUrl.indexOf("http") > -1) {								photo = item.imgUrl;							} else {								photo = "${ctx}/" + item.imgUrl;							}							 return '<img src="'		                        + (photo) + '" alt="">'		                        + item.name + '（' + item.mail + '），'		                        + item.org + '  ' + item.department;						}					}).result(function(event, item) {				$("#teacher").val(item.name + '（' + item.mail + '），' + item.org + '  ' + item.department);				$("#fdElementId").val(item.id);				$("#fdElementName").val(item.name);			});			$("#teacher").on("focus",function(){				if($("#errorinfo")[0]){					$("#teacher").val("");					$("#errorinfo").remove();				}			});		}		//添加学校信息		if ($("#school")[0]) {			$("#school").autocomplete("${ctx}/ajax/user/getOrg", {				matchContains : true,				max : 100,				width : 466,				dataType : 'json',				// 加入对返回的json对象进行解析的函数，函数返回一个数组				parse : function(data) {					var rows = [];					for ( var i = 0; i < data.length; i++) {						rows[rows.length] = {							data : data[i],							value : data[i].name,							result : data[i].name						// 显示在输入文本框里的内容 ,						};					}					return rows;				},				formatItem : function(item) {					return item.name;				}			}).result(function(event, item) {				$("#school").val(item.name);				$("#fdElementId").val(item.id);				$("#fdElementName").val(item.name);			});				//学校联盟封页		var $progress, flag = true, pct, interval, countdown = 0, byteUped = 0;		if ($("#upPagePic")[0]){			 var $txt = $("#upPagePic").prev(".txt"), 			 $progress = $txt.prev(".progress").children(".bar"),			 $pct = $txt.children(".pct"),             $countdown = $txt.children(".countdown"),             flag = true,         	 pct,         	 interval,         	 countdown = 0,         	 byteUped = 0;             jQuery("#upPagePic").uploadify({             	'height' : 40,                 'width' : 68,                 'multi' : false,                 'simUploadLimit' : 1,                 'swf' : '${ctx}/resources/uploadify/uploadify.swf',                 "buttonClass": "btn btn-primary btn-large",                 'buttonText' : '上传',                 'uploader' :'${ctx}/common/file/o_upload',                 'auto' : true,                 'fileTypeExts' : '*.jpg;*.png;*.bmp;*.jpeg;',                 'onInit' : function(){                 	$("#upMaterial").next(".uploadify-queue").remove();                 },                 'onUploadStart' : function (file) {},                 'onUploadSuccess' : function (file, data, Response) {                     if (Response) {                     	$countdown.text("00:00:00");                     	$progress.width("0");                     	$pct.text("0%");                         var objvalue = eval("(" + data + ")");                         jQuery("#attIdID").val(objvalue.attId);                         jQuery("#upPagePic").val(objvalue.attId);                         $("#imgshow").hide();                         $(".cutimg-box").show();                         var preImg = '${ctx}/common/file/image/' + objvalue.attId;                         var imgSrc = escape(preImg);                         $("#iframeimg").attr("src","${ctx}/common/imageCut/page?imgSrcPath="+imgSrc+"&zoomWidth=430&zoomHeight=190&imgId="+objvalue.attId);                                            }                                     },                 'onUploadProgress' : function(file, bytesUploaded, bytesTotal, totalBytesUploaded, totalBytesTotal) {                 	 pct = Math.round((bytesUploaded/bytesTotal)*100)+'%';                 	byteUped = bytesUploaded;                 	if(flag){                 		interval = setInterval(uploadSpeed,100);                 		flag = false;                 	}                 	if(bytesUploaded == bytesTotal){                 		clearInterval(interval);                 	}                 	                 	$progress.width(pct);                 	$pct.text(pct);                 	countdown>0 && $countdown.text(secTransform((bytesTotal-bytesUploaded)/countdown*10));                  }             });             function uploadSpeed(){         		countdown = byteUped - countdown;         	}         	function secTransform(s){         		if( typeof s == "number"){         			s = Math.ceil(s);         			var t = "";         			if(s>3600){         				t= completeZero(Math.ceil(s/3600)) + ":" + completeZero(Math.ceil(s%3600/60)) + ":" + completeZero(s%3600%60) ;         			} else if(s>60){         				t= "00:" + completeZero(Math.ceil(s/60)) + ":" + completeZero(s%60) ;         			} else {         				t= "00:00:" + completeZero(s);         			}         			return t;         		}else{         			return null;         		}		         	}         	function completeZero(n){         		return n<10 ? "0"+n : n;         	}		  }		}		$("#school").on("focus",function(){			if($("#errorinfo")[0]){				$("#school").val("");				$("#errorinfo").remove();			}		});	});	function successSelectArea(imgSrc){        var now=new Date();        var number = now.getSeconds();        jQuery("#imgshow").attr('src',  imgSrc+"?n="+number);        $(".cutimg-box").hide();        //imgshow        $("#imgshow").show();    }	//保存	function saveMater(){		$("#inputForm").trigger("submit");	} </script></body></html>